<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SABBAK ERP | Final Full Version</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a', 
                        darker: '#020617', 
                        card: '#1e293b',
                        accent: '#3b82f6', 
                        success: '#10b981', 
                        danger: '#ef4444', 
                        warning: '#f59e0b'
                    },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* --- CSS Fixes for Full Height --- */
        body { 
            background-color: #0f172a; 
            color: #f1f5f9; 
            font-family: 'Tajawal'; 
            overflow: hidden; /* يمنع سكرول المتصفح الرئيسي */
            height: 100vh; 
            width: 100vw; 
            display: flex;
            flex-direction: column;
        }

        /* تنسيق الحقول */
        input, select, textarea {
            background-color: #334155 !important;
            color: #ffffff !important;
            border: 1px solid #475569 !important;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
        }
        input:focus, select:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }

        /* سكرول بار */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }

        /* منطقة الطباعة */
        #print-area-wrapper { position: absolute; left: -9999px; top: -9999px; }

        /* اللودر */
        #loader {
            position: fixed; inset: 0; background: #0f172a; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 60px; height: 60px; border: 6px solid #1e293b;
            border-top: 6px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* === حل مشكلة التابلت والموبايل === */
        .layout-wrapper { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .view-container { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        /* POS Layout Fixes */
        .pos-layout { display: flex; height: 100%; flex-direction: column; overflow: hidden; }
        @media (min-width: 1024px) { .pos-layout { flex-direction: row; } }
        
        .pos-products { flex: 1; overflow-y: auto; padding-bottom: 80px; } /* مساحة للقائمة السفلية في الموبايل */
        @media (min-width: 1024px) { .pos-products { padding-bottom: 0; } }

        .pos-cart { 
            display: flex; flex-direction: column; 
            background: #1e293b; border-top: 1px solid #334155; 
            height: 45vh; /* ارتفاع السلة في الموبايل */
            position: relative; z-index: 20;
        }
        @media (min-width: 1024px) { 
            .pos-cart { height: 100%; width: 380px; border-top: none; border-right: 1px solid #334155; } 
        }

        .cart-items-scroll { flex: 1; overflow-y: auto; min-height: 0; }
        .cart-footer { flex-shrink: 0; padding: 1rem; background: #1e293b; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-6 text-accent font-bold text-xl animate-pulse">جاري تحميل نظام المهندس...</p>
    </div>

    <div class="layout-wrapper">
        <aside class="hidden lg:flex w-64 bg-darker border-l border-gray-800 flex-col z-30 shadow-2xl">
            <div class="p-6 text-center border-b border-gray-800 bg-gray-900/50 h-20 flex items-center justify-center gap-3">
                <i class="fa fa-faucet text-3xl text-accent"></i>
                <h1 class="text-2xl font-black text-white tracking-wider">SABBAK</h1>
            </div>
            <nav class="flex-1 p-3 space-y-2 overflow-y-auto">
                <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all active-nav group">
                    <i class="fa fa-chart-pie text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">الرئيسية</span>
                </button>
                <button onclick="app.nav('pos')" id="nav-pos" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all group">
                    <i class="fa fa-cash-register text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">نقطة البيع</span>
                </button>
                <button onclick="app.nav('inventory')" id="nav-inventory" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all group">
                    <i class="fa fa-boxes-stacked text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">المخزن</span>
                </button>
                <button onclick="app.nav('partners')" id="nav-partners" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all group">
                    <i class="fa fa-users text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">العملاء</span>
                </button>
                <button onclick="app.nav('finance')" id="nav-finance" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all group">
                    <i class="fa fa-wallet text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">الخزينة</span>
                </button>
                <button onclick="app.nav('invoices')" id="nav-invoices" class="nav-btn w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-800 text-gray-400 transition-all group">
                    <i class="fa fa-file-invoice text-xl group-hover:text-white"></i><span class="font-bold group-hover:text-white">الفواتير</span>
                </button>
            </nav>
            <div class="p-4 mt-auto">
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                    <p class="text-xs text-gray-400 mb-1">الخزينة</p>
                    <h2 class="text-xl font-bold text-success" id="sidebar-safe">0.00</h2>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="h-16 bg-darker/90 backdrop-blur border-b border-gray-800 flex items-center justify-between px-4 z-10 shrink-0">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-white">لوحة القيادة</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.location.reload()" class="w-10 h-10 rounded-full bg-gray-800 text-gray-400 hover:text-white flex items-center justify-center"><i class="fa fa-sync-alt"></i></button>
                    <div class="w-10 h-10 rounded-full bg-accent text-white font-bold flex items-center justify-center border-2 border-gray-700">A</div>
                </div>
            </header>

            <div class="view-container bg-dark">
                
                <div id="view-dashboard" class="view-section fade-in h-full overflow-y-auto p-4 pb-24 lg:pb-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-card p-5 rounded-2xl border border-gray-700 shadow-lg flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-accent/10 text-accent flex items-center justify-center text-2xl"><i class="fa fa-coins"></i></div>
                            <div><p class="text-gray-400 text-xs font-bold">المبيعات</p><h3 class="text-2xl font-black text-white" id="dash-sales">0</h3></div>
                        </div>
                        <div class="bg-card p-5 rounded-2xl border border-gray-700 shadow-lg flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-success/10 text-success flex items-center justify-center text-2xl"><i class="fa fa-arrow-trend-up"></i></div>
                            <div><p class="text-gray-400 text-xs font-bold">الأرباح</p><h3 class="text-2xl font-black text-white" id="dash-profit">0</h3></div>
                        </div>
                        <div class="bg-card p-5 rounded-2xl border border-gray-700 shadow-lg flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-warning/10 text-warning flex items-center justify-center text-2xl"><i class="fa fa-users"></i></div>
                            <div><p class="text-gray-400 text-xs font-bold">الديون</p><h3 class="text-2xl font-black text-white" id="dash-debt">0</h3></div>
                        </div>
                        <div class="bg-card p-5 rounded-2xl border border-gray-700 shadow-lg flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-danger/10 text-danger flex items-center justify-center text-2xl"><i class="fa fa-box-open"></i></div>
                            <div><p class="text-gray-400 text-xs font-bold">النواقص</p><h3 class="text-2xl font-black text-white" id="dash-low">0</h3></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-card p-6 rounded-2xl border border-gray-700">
                            <h3 class="font-bold text-lg mb-4 text-white">تحليل المبيعات</h3>
                            <div class="h-64 flex justify-center"><canvas id="mainChart"></canvas></div>
                        </div>
                        <div class="bg-card p-6 rounded-2xl border border-gray-700">
                            <h3 class="font-bold text-lg mb-4 text-white">آخر العمليات</h3>
                            <div id="dash-recent-tx" class="space-y-3 max-h-64 overflow-y-auto pr-1"></div>
                        </div>
                    </div>
                </div>

                <div id="view-pos" class="view-section hidden pos-layout fade-in">
                    
                    <div class="pos-products flex flex-col bg-dark flex-1 min-h-0">
                        <div class="p-3 bg-gray-900 border-b border-gray-800 space-y-3 shrink-0">
                            <div class="relative">
                                <i class="fa fa-search absolute right-4 top-3.5 text-gray-400"></i>
                                <input id="pos-search" onkeyup="app.filterPos()" type="text" placeholder="بحث..." class="pl-10 bg-gray-800 border-gray-700">
                            </div>
                            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="cat-filters">
                                <button onclick="app.filterCat('all')" class="cat-btn active px-4 py-2 rounded-lg bg-accent text-white text-sm font-bold whitespace-nowrap shadow">الكل</button>
                                <button onclick="app.filterCat('تأسيس')" class="cat-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-300 text-sm font-bold whitespace-nowrap border border-gray-700">تأسيس</button>
                                <button onclick="app.filterCat('نواكل')" class="cat-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-300 text-sm font-bold whitespace-nowrap border border-gray-700">نواكل</button>
                                <button onclick="app.filterCat('اكسسوار')" class="cat-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-300 text-sm font-bold whitespace-nowrap border border-gray-700">اكسسوار</button>
                            </div>
                        </div>
                        <div id="pos-grid" class="p-3 grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 content-start"></div>
                    </div>

                    <div class="pos-cart shadow-2xl">
                        <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center shrink-0">
                            <span class="font-bold text-white flex items-center gap-2"><i class="fa fa-receipt text-accent"></i> الفاتورة</span>
                            <div class="px-2 py-1 bg-gray-700 rounded text-xs text-gray-300" id="cart-count">0 صنف</div>
                        </div>
                        
                        <div id="cart-items" class="cart-items-scroll p-2 space-y-1 bg-gray-900/50">
                            <div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-50">
                                <i class="fa fa-basket-shopping text-4xl mb-2"></i>
                                <p>أضف منتجات</p>
                            </div>
                        </div>

                        <div class="cart-footer space-y-2">
                            <div class="flex justify-between items-center bg-gray-700/50 p-2 rounded-lg">
                                <span class="text-gray-300 font-bold text-sm">الإجمالي</span>
                                <span class="text-2xl font-black text-accent" id="cart-total">0.00</span>
                            </div>
                            <select id="pos-customer" class="bg-gray-700 border-gray-600 text-sm font-bold w-full py-2 px-3 rounded-lg">
                                <option value="cash">عميل نقدي (طياري)</option>
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="app.checkout('cash')" class="bg-success hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95">
                                    <i class="fa fa-money-bill"></i> كاش
                                </button>
                                <button onclick="app.checkout('credit')" class="bg-warning hover:bg-yellow-600 text-black font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95">
                                    <i class="fa fa-file-invoice"></i> آجل
                                </button>
                            </div>
                            <button onclick="app.clearCart()" class="w-full py-1 text-xs text-danger hover:bg-danger/10 rounded">إلغاء وتفريغ</button>
                        </div>
                    </div>
                </div>

                <div id="view-inventory" class="view-section hidden h-full overflow-y-auto p-4 pb-24 lg:pb-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <input id="inv-search" onkeyup="app.filterInv()" type="text" placeholder="بحث عن منتج..." class="md:w-1/2 bg-card border-gray-700">
                        <button onclick="app.toggleModal('modal-product')" class="bg-accent text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2">
                            <i class="fa fa-plus-circle"></i> صنف جديد
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-gray-700 bg-card shadow-xl">
                        <table class="w-full text-right text-sm whitespace-nowrap">
                            <thead class="bg-gray-900 text-gray-400 text-xs font-bold uppercase"><tr><th class="p-4">المنتج</th><th>السعر</th><th>الكمية</th><th>تحكم</th></tr></thead>
                            <tbody id="inv-table" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-partners" class="view-section hidden h-full overflow-y-auto p-4 pb-24 lg:pb-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-2xl text-white">العملاء</h3>
                        <button onclick="app.addCustomerPrompt()" class="bg-accent text-white px-5 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2"><i class="fa fa-user-plus"></i> عميل جديد</button>
                    </div>
                    <div id="customers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-finance" class="view-section hidden h-full overflow-y-auto p-4 pb-24 lg:pb-4">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-card p-6 rounded-2xl border border-gray-700 h-fit shadow-lg">
                            <h3 class="font-bold text-xl text-danger mb-4 flex items-center gap-2"><i class="fa fa-money-bill-transfer"></i> تسجيل مصروف</h3>
                            <div class="space-y-4">
                                <input id="exp-desc" type="text" placeholder="بند الصرف (مثال: كهرباء)">
                                <input id="exp-amount" type="number" placeholder="المبلغ">
                                <button onclick="app.addExpense()" class="w-full bg-danger text-white font-bold py-3 rounded-xl shadow-lg">تأكيد الصرف</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-card rounded-2xl border border-gray-700 overflow-hidden h-[600px] flex flex-col shadow-lg">
                            <div class="p-4 bg-gray-800 font-bold border-b border-gray-700 text-white">سجل المعاملات</div>
                            <div class="flex-1 overflow-y-auto">
                                <table class="w-full text-right text-sm"><tbody id="finance-table" class="divide-y divide-gray-700"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-invoices" class="view-section hidden h-full overflow-y-auto p-4 pb-24 lg:pb-4">
                    <h3 class="font-bold text-2xl text-white mb-6">أرشيف الفواتير</h3>
                    <div class="overflow-x-auto rounded-xl border border-gray-700 bg-card shadow-xl">
                        <table class="w-full text-right text-sm whitespace-nowrap">
                            <thead class="bg-gray-900 text-gray-400 text-xs font-bold uppercase"><tr><th class="p-4">#</th><th>التاريخ</th><th>العميل</th><th>المبلغ</th><th>تحميل</th></tr></thead>
                            <tbody id="invoices-table" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <nav class="lg:hidden fixed bottom-0 w-full bg-darker/95 backdrop-blur border-t border-gray-800 flex justify-around p-2 z-50 pb-safe shadow-lg h-16">
            <button onclick="app.nav('dashboard')" id="mob-dashboard" class="flex flex-col items-center text-gray-500 text-[10px] p-1 rounded transition active-mob"><i class="fa fa-chart-pie text-xl mb-1"></i><span>رئيسية</span></button>
            <button onclick="app.nav('pos')" id="mob-pos" class="flex flex-col items-center text-gray-500 text-[10px] p-1 rounded transition"><i class="fa fa-cash-register text-xl mb-1"></i><span>بيع</span></button>
            <button onclick="app.nav('inventory')" id="mob-inventory" class="flex flex-col items-center text-gray-500 text-[10px] p-1 rounded transition"><i class="fa fa-boxes text-xl mb-1"></i><span>مخزن</span></button>
            <button onclick="app.nav('partners')" id="mob-partners" class="flex flex-col items-center text-gray-500 text-[10px] p-1 rounded transition"><i class="fa fa-users text-xl mb-1"></i><span>عملاء</span></button>
        </nav>
    </div>

    <div id="modal-product" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-card w-full max-w-lg rounded-2xl border border-gray-700 shadow-2xl p-6 relative">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                <h3 class="font-bold text-white text-lg">إضافة صنف جديد</h3>
                <button onclick="app.toggleModal('modal-product')" class="text-gray-400 hover:text-white transition"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input id="m-name" type="text" placeholder="اسم المنتج (مطلوب)">
                <div class="grid grid-cols-2 gap-4">
                    <select id="m-cat"><option value="تأسيس">تأسيس</option><option value="نواكل">نواكل</option><option value="اكسسوار">اكسسوار</option></select>
                    <input id="m-barcode" type="text" placeholder="باركود (اختياري)">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="m-buy" type="number" placeholder="سعر الشراء">
                    <input id="m-sell" type="number" placeholder="سعر البيع">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="m-qty" type="number" placeholder="الكمية">
                    <input id="m-min" type="number" value="5" placeholder="حد الطلب">
                </div>
                <button onclick="app.saveProduct()" class="w-full bg-accent hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4">حفظ البيانات</button>
            </div>
        </div>
    </div>

    <div id="print-area-wrapper">
        <div id="receipt-template" style="width: 78mm; background: #fff; color: #000; padding: 10px; font-family: sans-serif; font-size: 11px;">
            <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 8px; margin-bottom: 8px;">
                <h2 style="margin: 0; font-size: 16px; font-weight: 800;">المهندس للسباكة</h2>
                <p style="margin: 3px 0; font-size: 10px;">إيصال بيع</p>
                <p style="font-size: 9px;">تاريخ: <span id="r-date"></span> | رقم: <span id="r-id"></span></p>
            </div>
            <div style="margin-bottom: 8px;"><strong>العميل: </strong> <span id="r-customer"></span></div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead><tr style="border-bottom: 1px solid #000;"><th style="text-align:right">صنف</th><th style="text-align:center">عدد</th><th style="text-align:left">سعر</th></tr></thead>
                <tbody id="r-items"></tbody>
            </table>
            <div style="border-top: 1px solid #000; margin-top: 8px; padding-top: 5px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                <span>الإجمالي:</span><span id="r-total"></span>
            </div>
            <div style="margin-top: 10px; text-align: center;"><svg id="r-barcode"></svg></div>
            <div style="text-align:center; font-size:9px; margin-top:5px;">البضاعة المباعة ترد وتستبدل خلال 14 يوم</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, deleteDoc, writeBatch, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === FIREBASE CONFIG (استبدل البيانات) ===
        const firebaseConfig = {
            apiKey: "AIzaSyChNPxcmhJywadU4QhOPs-pgulxvCNr0ec",
            authDomain: "adham-atia.firebaseapp.com",
            projectId: "adham-atia",
            storageBucket: "adham-atia.firebasestorage.app",
            messagingSenderId: "743105915809",
            appId: "1:743105915809:web:af26bab182b60e1870b9e0"
        };

        let db;
        try {
            const appInit = initializeApp(firebaseConfig);
            db = getFirestore(appInit);
            console.log("Connected");
        } catch(e) { Swal.fire('Error', 'Connection Failed', 'error'); }

        const state = { products: [], cart: [], customers: [], filterCat: 'all', chart: null };

        // === APP LOGIC ===
        window.app = {
            nav: (view) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.getElementById('page-title').innerText = view === 'pos' ? 'نقطة البيع' : view === 'dashboard' ? 'لوحة القيادة' : view === 'inventory' ? 'إدارة المخزن' : view.toUpperCase();
                
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-gray-800', 'text-white', 'border-l-4', 'border-accent');
                    b.classList.add('text-gray-400');
                });
                const activeBtn = document.getElementById(`nav-${view}`);
                if(activeBtn) activeBtn.classList.add('bg-gray-800', 'text-white', 'border-l-4', 'border-accent');
                
                document.querySelectorAll('#mob-dashboard, #mob-pos, #mob-inventory, #mob-partners').forEach(b => b.classList.remove('text-accent', 'font-bold'));
                const mob = document.getElementById(`mob-${view}`);
                if(mob) mob.classList.add('text-accent', 'font-bold');
            },

            toggleModal: (id) => {
                const el = document.getElementById(id);
                el.classList.contains('hidden') ? el.classList.remove('hidden') : el.classList.add('hidden');
            },

            // --- INVENTORY ---
            saveProduct: async () => {
                const name = document.getElementById('m-name').value;
                if(!name) return Swal.fire('تنبيه', 'الاسم مطلوب', 'warning');
                Swal.showLoading();
                try {
                    await addDoc(collection(db, "products"), {
                        name, category: document.getElementById('m-cat').value,
                        barcode: document.getElementById('m-barcode').value || Date.now().toString(),
                        buy: Number(document.getElementById('m-buy').value),
                        sell: Number(document.getElementById('m-sell').value),
                        qty: Number(document.getElementById('m-qty').value),
                        min: Number(document.getElementById('m-min').value)
                    });
                    window.app.toggleModal('modal-product');
                    document.querySelectorAll('#modal-product input').forEach(i => i.value = '');
                    Swal.fire({icon:'success', title:'تم الحفظ', toast:true, timer:1500, position:'top-end', showConfirmButton:false});
                } catch(e) { Swal.fire('خطأ', e.message, 'error'); }
            },

            delProduct: async (id) => {
                if((await Swal.fire({title:'حذف؟', icon:'warning', showCancelButton:true})).isConfirmed) {
                    await deleteDoc(doc(db, "products", id));
                }
            },

            filterInv: () => {
                const q = document.getElementById('inv-search').value.toLowerCase();
                document.getElementById('inv-table').childNodes.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
            },

            // --- POS ---
            filterCat: (cat) => {
                state.filterCat = cat;
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('bg-accent', 'text-white', 'active'));
                document.querySelectorAll('.cat-btn').forEach(b => {
                    if(b.innerText.includes(cat === 'all' ? 'الكل' : cat)) b.classList.add('bg-accent', 'text-white');
                    else b.classList.add('bg-gray-800', 'text-gray-300');
                });
                window.app.filterPos();
            },

            filterPos: () => {
                const q = document.getElementById('pos-search').value.toLowerCase();
                const grid = document.getElementById('pos-grid');
                grid.innerHTML = '';
                state.products.forEach(p => {
                    const matchName = p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.includes(q));
                    const matchCat = state.filterCat === 'all' || p.category === state.filterCat;
                    if(matchName && matchCat) {
                        grid.innerHTML += `
                            <div onclick="window.app.addToCart('${p.id}')" class="bg-card p-3 rounded-xl border border-gray-700 cursor-pointer hover:border-accent relative overflow-hidden active:scale-95 transition group select-none shadow-md h-28 flex flex-col justify-between">
                                ${p.qty<=0 ? '<div class="absolute inset-0 bg-black/80 flex items-center justify-center text-danger font-bold z-10 text-sm border border-danger m-2 rounded-lg">نفذت الكمية</div>' : ''}
                                <div class="flex justify-between items-start">
                                    <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded border border-gray-700">${p.category}</span>
                                    <span class="text-[10px] ${p.qty<=p.min?'text-danger font-bold':'text-success'}">${p.qty} متاح</span>
                                </div>
                                <h4 class="font-bold text-white text-sm line-clamp-2 leading-tight">${p.name}</h4>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-base font-black text-white">${p.sell} <small class="text-[9px] text-gray-500">ج.م</small></span>
                                    <div class="w-6 h-6 rounded-full bg-accent flex items-center justify-center text-white text-xs shadow-lg"><i class="fa fa-plus"></i></div>
                                </div>
                            </div>`;
                    }
                });
            },

            addToCart: (id) => {
                const p = state.products.find(x => x.id === id);
                if(p.qty <= 0) return Swal.fire({toast:true, icon:'error', title:'غير متوفر', position:'top', timer:1500, showConfirmButton:false});
                const ex = state.cart.find(x => x.id === id);
                if(ex) {
                    if(ex.qty >= p.qty) return Swal.fire({toast:true, icon:'warning', title:'الكمية غير كافية', position:'top', timer:1500, showConfirmButton:false});
                    ex.qty++;
                } else { state.cart.push({...p, qty:1}); }
                window.app.renderCart();
            },

            renderCart: () => {
                const div = document.getElementById('cart-items');
                div.innerHTML = '';
                let total = 0;
                state.cart.forEach((item, i) => {
                    total += item.sell * item.qty;
                    div.innerHTML += `
                        <div class="bg-gray-800/50 p-2 rounded-lg border border-gray-700/50 flex justify-between items-center text-sm mb-2">
                            <div class="flex-1 min-w-0 pr-2">
                                <div class="font-bold text-white truncate">${item.name}</div>
                                <div class="text-xs text-gray-400">${item.sell} ج.م</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex items-center bg-gray-900 rounded-lg border border-gray-700">
                                    <button onclick="window.app.upQty(${i}, -1)" class="w-7 h-7 text-gray-300 hover:text-white flex items-center justify-center font-bold text-sm border-l border-gray-700">-</button>
                                    <span class="w-6 text-center text-white text-sm font-bold">${item.qty}</span>
                                    <button onclick="window.app.upQty(${i}, 1)" class="w-7 h-7 text-gray-300 hover:text-white flex items-center justify-center font-bold text-sm border-r border-gray-700">+</button>
                                </div>
                                <button onclick="window.app.delCart(${i})" class="text-danger hover:bg-danger/20 p-1.5 rounded transition"><i class="fa fa-trash"></i></button>
                            </div>
                        </div>`;
                });
                if(state.cart.length === 0) div.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-50 py-10"><i class="fa fa-basket-shopping text-4xl mb-2"></i><p>أضف منتجات</p></div>`;
                document.getElementById('cart-total').innerText = total.toFixed(2);
                document.getElementById('cart-count').innerText = state.cart.length + ' صنف';
            },

            upQty: (i, v) => {
                const item = state.cart[i];
                const p = state.products.find(x => x.id === item.id);
                if(v === 1 && item.qty >= p.qty) return;
                if(v === -1 && item.qty === 1) return window.app.delCart(i);
                item.qty += v;
                window.app.renderCart();
            },

            delCart: (i) => { state.cart.splice(i, 1); window.app.renderCart(); },
            clearCart: () => { state.cart = []; window.app.renderCart(); },

            checkout: async (type) => {
                if(state.cart.length === 0) return Swal.fire('السلة فارغة');
                const cid = document.getElementById('pos-customer').value;
                if(type === 'credit' && cid === 'cash') return Swal.fire('اختر عميل للآجل');
                
                Swal.showLoading();
                const total = Number(document.getElementById('cart-total').innerText);
                const cName = document.getElementById('pos-customer').options[document.getElementById('pos-customer').selectedIndex].text;
                let profit = 0;
                const batch = writeBatch(db);

                state.cart.forEach(i => {
                    profit += (i.sell - i.buy) * i.qty;
                    batch.update(doc(db, "products", i.id), { qty: increment(-i.qty) });
                });

                const ref = doc(collection(db, "invoices"));
                batch.set(ref, {
                    date: new Date().toISOString(), total, profit, type, 
                    customerId: cid, customerName: cName, items: state.cart
                });

                const txRef = doc(collection(db, "transactions"));
                if(type === 'cash') batch.set(txRef, { type: 'sale_cash', amount: total, profit, date: new Date().toISOString(), details: `بيع نقدي #${ref.id.substring(0,5)}` });
                else {
                    batch.set(txRef, { type: 'sale_credit', amount: total, profit, date: new Date().toISOString(), details: `بيع آجل #${ref.id.substring(0,5)}` });
                    batch.update(doc(db, "customers", cid), { debt: increment(total) });
                }

                await batch.commit();
                await window.app.printReceipt(state.cart, total, ref.id, cName);
                state.cart = []; window.app.renderCart();
                Swal.fire({icon:'success', title:'تم البيع', toast:true, timer:1500, position:'top', showConfirmButton:false});
            },

            addCustomerPrompt: async () => {
                const {value: name} = await Swal.fire({input:'text', inputLabel:'اسم العميل', showCancelButton:true});
                if(name) await addDoc(collection(db, "customers"), {name, debt:0});
            },

            payDebt: async (id) => {
                const {value: amt} = await Swal.fire({input:'number', inputLabel:'المبلغ', showCancelButton:true});
                if(amt) {
                    const b = writeBatch(db);
                    b.update(doc(db, "customers", id), {debt: increment(-Number(amt))});
                    b.set(doc(collection(db, "transactions")), {type: 'payment_in', amount: Number(amt), date: new Date().toISOString(), details: 'سداد دين'});
                    await b.commit();
                    Swal.fire('تم السداد');
                }
            },

            addExpense: async () => {
                const desc = document.getElementById('exp-desc').value;
                const amt = document.getElementById('exp-amount').value;
                if(desc && amt) {
                    await addDoc(collection(db, "transactions"), {type:'expense', amount:Number(amt), details:desc, date:new Date().toISOString()});
                    document.getElementById('exp-desc').value = '';
                    document.getElementById('exp-amount').value = '';
                    Swal.fire({icon:'success', title:'تم التسجيل', toast:true, timer:1000, position:'top', showConfirmButton:false});
                }
            },

            printReceipt: (items, total, id, cName) => {
                return new Promise(resolve => {
                    document.getElementById('r-date').innerText = new Date().toLocaleDateString();
                    document.getElementById('r-id').innerText = id.substring(0,6);
                    document.getElementById('r-customer').innerText = cName;
                    document.getElementById('r-total').innerText = total.toFixed(2);
                    document.getElementById('r-items').innerHTML = items.map(i => `
                        <tr style="border-bottom:1px dashed #eee">
                            <td style="text-align:right">${i.name}</td>
                            <td style="text-align:center">${i.qty}</td>
                            <td style="text-align:left">${(i.sell*i.qty).toFixed(2)}</td>
                        </tr>`).join('');
                    JsBarcode("#r-barcode", id.substring(0,8), {height:25, displayValue:false});
                    const el = document.getElementById('receipt-template');
                    html2pdf().from(el).set({
                        margin:0, filename:`Inv_${id.substring(0,6)}.pdf`,
                        image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2},
                        jsPDF:{unit:'mm', format:[80, 200]}
                    }).save().then(resolve);
                });
            },

            downloadInvoice: async (id) => {
                const inv = state.invoices.find(i => i.id === id);
                if(inv) window.app.printReceipt(inv.items, inv.total, inv.id, inv.customerName);
            }
        };

        // ================= LISTENERS =================
        onSnapshot(collection(db, "products"), (snap) => {
            state.products = [];
            let low = 0, invH = '', cats = {};
            snap.forEach(d => {
                const p = {id:d.id, ...d.data()};
                state.products.push(p);
                if(p.qty <= p.min) low++;
                cats[p.category] = (cats[p.category] || 0) + 1;
                invH += `
                    <tr class="hover:bg-gray-800 border-b border-gray-800">
                        <td class="p-4 font-bold text-white">${p.name}</td>
                        <td class="text-xs text-gray-500">${p.barcode}</td>
                        <td><span class="bg-gray-800 px-2 py-1 rounded text-xs text-gray-400 border border-gray-700">${p.category}</span></td>
                        <td class="text-accent font-bold">${p.sell}</td>
                        <td class="${p.qty<=p.min?'text-danger font-black':'text-success font-bold'}">${p.qty}</td>
                        <td><button onclick="window.app.delProduct('${p.id}')" class="text-danger p-2"><i class="fa fa-trash"></i></button></td>
                    </tr>`;
            });
            document.getElementById('inv-table').innerHTML = invH;
            document.getElementById('dash-low').innerText = low;
            document.getElementById('loader').style.display = 'none';
            window.app.filterPos();
            updateChart(cats);
        });

        onSnapshot(collection(db, "customers"), (snap) => {
            state.customers = [];
            let debt = 0, grid = '', opts = '<option value="cash">عميل نقدي (طياري)</option>';
            snap.forEach(d => {
                const c = {id:d.id, ...d.data()};
                state.customers.push(c);
                debt += c.debt;
                opts += `<option value="${c.id}">${c.name}</option>`;
                grid += `
                    <div class="bg-card p-5 rounded-xl border border-gray-700 flex justify-between items-center relative overflow-hidden group hover:border-accent transition">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${c.debt>0?'bg-danger':'bg-success'}"></div>
                        <div><h4 class="font-bold text-white">${c.name}</h4><p class="text-xs text-gray-400">دين: <span class="${c.debt>0?'text-danger font-bold':'text-success'}">${c.debt.toFixed(2)}</span></p></div>
                        <button onclick="window.app.payDebt('${c.id}')" class="bg-gray-800 hover:bg-white hover:text-black px-3 py-1 rounded text-xs transition border border-gray-600">سداد</button>
                    </div>`;
            });
            document.getElementById('customers-grid').innerHTML = grid;
            document.getElementById('pos-customer').innerHTML = opts;
            document.getElementById('dash-debt').innerText = debt.toFixed(2);
        });

        onSnapshot(query(collection(db, "transactions"), orderBy("date", "desc"), limit(50)), (snap) => {
            let sales = 0, profit = 0, safe = 0, html = '', recent = '';
            const today = new Date().toDateString();
            snap.forEach((d, i) => {
                const t = d.data();
                if(['sale_cash','payment_in'].includes(t.type)) safe += t.amount;
                if(t.type === 'expense') safe -= t.amount;
                if(new Date(t.date).toDateString() === today && t.type.includes('sale')) { sales += t.amount; profit += (t.profit||0); }
                const isInc = ['sale_cash','payment_in'].includes(t.type);
                html += `
                    <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                        <td class="p-3 text-xs text-gray-400">${new Date(t.date).toLocaleDateString()}</td>
                        <td><span class="px-2 py-0.5 rounded text-[10px] ${isInc?'bg-success/10 text-success border border-success/20':'bg-danger/10 text-danger border border-danger/20'}">${t.type}</span></td>
                        <td class="text-xs text-white">${t.details}</td>
                        <td class="font-bold ${isInc?'text-success':'text-danger'}">${t.amount}</td>
                    </tr>`;
                if(i < 5) recent += `<div class="flex justify-between items-center text-sm border-b border-gray-700 pb-2 mb-2 last:border-0"><span class="text-white text-xs">${t.details}</span><span class="${isInc?'text-success':'text-danger'} font-bold">${t.amount}</span></div>`;
            });
            document.getElementById('finance-table').innerHTML = html;
            document.getElementById('dash-recent-tx').innerHTML = recent;
            document.getElementById('dash-sales').innerText = sales.toFixed(0);
            document.getElementById('dash-profit').innerText = profit.toFixed(0);
            document.getElementById('sidebar-safe').innerText = safe.toFixed(2);
        });

        onSnapshot(query(collection(db, "invoices"), orderBy("date", "desc"), limit(50)), (snap) => {
            state.invoices = [];
            let html = '';
            snap.forEach(d => {
                const i = {id:d.id, ...d.data()};
                state.invoices.push(i);
                html += `
                    <tr class="hover:bg-gray-800 border-b border-gray-800">
                        <td class="p-4 text-xs font-mono text-gray-400">#${i.id.substring(0,6)}</td>
                        <td class="text-xs text-white">${new Date(i.date).toLocaleDateString()}</td>
                        <td class="text-accent font-bold">${i.customerName}</td>
                        <td class="font-bold text-white">${i.total}</td>
                        <td><span class="text-[10px] bg-gray-800 px-2 py-1 rounded border border-gray-600">${i.type}</span></td>
                        <td><button onclick="window.app.downloadInvoice('${i.id}')" class="text-accent hover:text-white border border-accent hover:bg-accent px-2 py-1 rounded text-xs transition"><i class="fa fa-download"></i></button></td>
                    </tr>`;
            });
            document.getElementById('invoices-table').innerHTML = html;
        });

        function updateChart(data) {
            const ctx = document.getElementById('mainChart');
            if(state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444'], borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right', labels:{color:'#94a3b8', font:{family:'Tajawal'}}} }, cutout:'75%' }
            });
        }
    </script>
</body>
</html>
