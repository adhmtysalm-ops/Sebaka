<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SABBAK ERP | الإصدار الحديث</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',    /* Royal Blue */
                        secondary: '#475569',  /* Slate */
                        bgMain: '#f1f5f9',     /* Very Light Gray */
                        surface: '#ffffff',    /* White */
                        accent: '#0ea5e9',     /* Sky Blue */
                        success: '#10b981',    
                        danger: '#ef4444',     
                        warning: '#f59e0b',
                        borderC: '#e2e8f0'     /* Light Border */
                    },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025)'
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #f1f5f9; 
            color: #1e293b; 
            font-family: 'Tajawal'; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
            display: flex;
            flex-direction: column;
        }

        /* تنسيق الحقول بستايل فاتح */
        input, select, textarea {
            background-color: #ffffff !important;
            color: #334155 !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 0.75rem;
            padding: 0.75rem;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        input:focus, select:focus { 
            border-color: #2563eb !important; 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important; 
        }

        /* تحسين الجداول */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { 
            text-align: right; padding: 12px; color: #64748b; 
            font-size: 0.85rem; font-weight: 700; 
            background: #f8fafc; border-bottom: 2px solid #e2e8f0;
            position: sticky; top: 0; z-index: 10;
        }
        td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        #print-area-wrapper { position: absolute; left: -9999px; top: -9999px; }

        #loader {
            position: fixed; inset: 0; background: #ffffff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f1f5f9;
            border-top: 4px solid #2563eb; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .layout-wrapper { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; background: #f1f5f9; }
        .view-container { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        /* POS Layout */
        .pos-layout { display: flex; height: 100%; flex-direction: column; overflow: hidden; }
        @media (min-width: 1024px) { .pos-layout { flex-direction: row; } }
        
        .pos-products { flex: 1; overflow-y: auto; padding-bottom: 80px; background: #f1f5f9; }
        @media (min-width: 1024px) { .pos-products { padding-bottom: 0; } }

        .pos-cart { 
            display: flex; flex-direction: column; 
            background: #ffffff; border-top: 1px solid #e2e8f0; 
            height: 50vh; 
            position: relative; z-index: 20; box-shadow: -4px 0 15px rgba(0,0,0,0.05);
        }
        @media (min-width: 1024px) { 
            .pos-cart { height: 100%; width: 420px; border-top: none; border-right: 1px solid #e2e8f0; } 
        }

        .cart-items-scroll { flex: 1; overflow-y: auto; min-height: 0; background: #f8fafc; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #ffffff; border: 1px solid #e2e8f0;
            border-radius: 0.75rem; max-height: 200px; overflow-y: auto;
            z-index: 50; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); margin-top: 4px;
        }
        .suggestion-item {
            padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; font-size: 0.9rem;
        }
        .suggestion-item:hover { background: #f1f5f9; color: #2563eb; }
        
        /* Return Mode Pulse */
        @keyframes returnPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .return-mode-active { border: 2px solid #ef4444 !important; animation: returnPulse 2s infinite; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-primary font-bold text-lg">جاري تحميل النظام...</p>
    </div>

    <div class="layout-wrapper">
        <aside class="hidden lg:flex w-72 bg-white border-l border-gray-200 flex-col z-30 shadow-soft">
            <div class="p-6 h-24 flex items-center gap-3 border-b border-gray-100">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-blue-700 flex items-center justify-center text-white text-xl shadow-lg shadow-blue-200"><i class="fa fa-faucet"></i></div>
                <div>
                    <h1 class="text-2xl font-black text-gray-800 tracking-tight">SABBAK</h1>
                    <p class="text-[11px] text-gray-500 font-medium">Enterprise System</p>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-chart-pie w-6 text-center text-lg group-hover:scale-110 transition"></i><span>الرئيسية</span>
                </button>
                <button onclick="app.nav('pos')" id="nav-pos" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-cash-register w-6 text-center text-lg group-hover:scale-110 transition"></i><span>نقطة البيع</span>
                </button>
                <button onclick="app.nav('inventory')" id="nav-inventory" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-boxes-stacked w-6 text-center text-lg group-hover:scale-110 transition"></i><span>المخزن</span>
                </button>
                <button onclick="app.nav('partners')" id="nav-partners" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-users w-6 text-center text-lg group-hover:scale-110 transition"></i><span>العملاء</span>
                </button>
                <button onclick="app.nav('finance')" id="nav-finance" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-wallet w-6 text-center text-lg group-hover:scale-110 transition"></i><span>المالية</span>
                </button>
                <button onclick="app.nav('invoices')" id="nav-invoices" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-xl text-gray-500 hover:bg-blue-50 hover:text-primary transition-all group font-medium">
                    <i class="fa fa-file-invoice w-6 text-center text-lg group-hover:scale-110 transition"></i><span>الفواتير</span>
                </button>
            </nav>

            <div class="p-4 mt-auto">
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-5 text-white shadow-xl">
                    <p class="text-xs text-gray-400 mb-2 flex justify-between"><span>الخزينة</span> <i class="fa fa-vault opacity-50"></i></p>
                    <h2 class="text-2xl font-bold tracking-wider" id="sidebar-safe">0.00</h2>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 z-10 shrink-0 shadow-sm">
                <div class="flex items-center gap-4">
                    <button class="lg:hidden text-gray-600"><i class="fa fa-bars text-xl"></i></button>
                    <h2 id="page-title" class="text-lg font-bold text-gray-800">لوحة القيادة</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.location.reload()" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 hover:bg-primary hover:text-white flex items-center justify-center transition hover:rotate-180 duration-500"><i class="fa fa-sync-alt"></i></button>
                    <div class="w-9 h-9 rounded-full bg-primary text-white font-bold flex items-center justify-center shadow-lg shadow-blue-200">A</div>
                </div>
            </header>

            <div class="view-container">
                
                <div id="view-dashboard" class="view-section fade-in h-full overflow-y-auto p-6 pb-24 lg:pb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-card hover:-translate-y-1 transition duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider">مبيعات اليوم</p><h3 class="text-2xl font-black text-gray-800 mt-1" id="dash-sales">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-primary flex items-center justify-center text-lg"><i class="fa fa-coins"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-card hover:-translate-y-1 transition duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider">الربح اليومي</p><h3 class="text-2xl font-black text-gray-800 mt-1" id="dash-profit">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-green-50 text-success flex items-center justify-center text-lg"><i class="fa fa-arrow-trend-up"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-card hover:-translate-y-1 transition duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider">قيمة المخزون</p><h3 class="text-xl font-black text-gray-800 mt-1" id="dash-stock-val">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-sky-50 text-accent flex items-center justify-center text-lg"><i class="fa fa-warehouse"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-card hover:-translate-y-1 transition duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider">النواقص</p><h3 class="text-2xl font-black text-gray-800 mt-1" id="dash-low">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-red-50 text-danger flex items-center justify-center text-lg"><i class="fa fa-bell"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-100 shadow-card">
                            <h3 class="font-bold text-lg text-gray-800 mb-6">توزيع المخزون</h3>
                            <div class="h-64 flex justify-center relative"><canvas id="mainChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-card flex flex-col">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">آخر العمليات</h3>
                            <div id="dash-recent-tx" class="space-y-3 overflow-y-auto flex-1 pr-1 custom-scroll"></div>
                        </div>
                    </div>
                </div>

                <div id="view-pos" class="view-section hidden pos-layout fade-in">
                    <div class="pos-products flex flex-col flex-1 min-h-0">
                        <div class="p-4 bg-white border-b border-gray-200 space-y-4 shrink-0 shadow-sm z-10">
                            <div class="flex gap-3">
                                <div class="relative flex-1">
                                    <i class="fa fa-search absolute right-4 top-3.5 text-gray-400"></i>
                                    <input id="pos-search" onkeyup="app.filterPos()" type="text" placeholder="بحث بالاسم أو الباركود..." class="pl-10 bg-gray-50 border-gray-200 focus:bg-white">
                                </div>
                                <button onclick="app.toggleReturnMode()" id="btn-return-mode" class="px-4 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 hover:bg-red-50 hover:text-danger hover:border-danger font-bold text-xs transition flex flex-col items-center justify-center min-w-[80px]">
                                    <i class="fa fa-rotate-left mb-1"></i> وضع المرتجع
                                </button>
                            </div>
                            
                            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="cat-filters">
                                <button onclick="app.filterCat('all')" class="cat-btn active px-5 py-2.5 rounded-xl bg-primary text-white text-sm font-bold shadow-lg shadow-blue-200 transition">الكل</button>
                                <button onclick="app.filterCat('تأسيس')" class="cat-btn px-5 py-2.5 rounded-xl bg-white text-gray-600 text-sm font-bold border border-gray-200 hover:bg-gray-50 transition">تأسيس</button>
                                <button onclick="app.filterCat('نواكل')" class="cat-btn px-5 py-2.5 rounded-xl bg-white text-gray-600 text-sm font-bold border border-gray-200 hover:bg-gray-50 transition">نواكل</button>
                                <button onclick="app.filterCat('اكسسوار')" class="cat-btn px-5 py-2.5 rounded-xl bg-white text-gray-600 text-sm font-bold border border-gray-200 hover:bg-gray-50 transition">اكسسوار</button>
                            </div>
                        </div>
                        
                        <div id="pos-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 content-start"></div>
                    </div>

                    <div class="pos-cart">
                        <div class="p-5 bg-white border-b border-gray-100 flex justify-between items-center shrink-0">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">الفاتورة</h3>
                                <p class="text-xs text-gray-400" id="tx-mode-label">بيع عادي</p>
                            </div>
                            <div class="px-3 py-1 bg-blue-50 text-primary rounded-lg text-xs font-bold" id="cart-count">0</div>
                        </div>
                        
                        <div id="cart-items" class="cart-items-scroll p-4 space-y-3">
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                                <i class="fa fa-cash-register text-5xl mb-3 text-gray-300"></i>
                                <p class="text-sm font-medium">ابدأ إضافة المنتجات</p>
                            </div>
                        </div>

                        <div class="cart-footer bg-white border-t border-gray-100 p-5 space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 font-bold text-sm">الإجمالي النهائي</span>
                                <span class="text-3xl font-black text-gray-800" id="cart-total">0.00</span>
                            </div>
                            
                            <div class="relative">
                                <select id="pos-customer" class="bg-gray-50 border-gray-200 text-sm font-bold w-full py-3 px-4 rounded-xl appearance-none cursor-pointer hover:border-primary">
                                    <option value="cash">عميل نقدي (طياري)</option>
                                </select>
                                <i class="fa fa-chevron-down absolute left-4 top-4 text-gray-400 text-xs pointer-events-none"></i>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="app.checkout('cash')" class="bg-success hover:bg-emerald-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-100 flex items-center justify-center gap-2 active:scale-95 transition">
                                    <i class="fa fa-money-bill-wave"></i> كاش
                                </button>
                                <button onclick="app.checkout('credit')" class="bg-warning hover:bg-amber-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-100 flex items-center justify-center gap-2 active:scale-95 transition">
                                    <i class="fa fa-user-clock"></i> آجل
                                </button>
                            </div>
                            <button onclick="app.clearCart()" class="w-full py-2 text-xs text-danger hover:bg-red-50 rounded-lg transition font-medium">إلغاء العملية</button>
                        </div>
                    </div>
                </div>

                <div id="view-inventory" class="view-section hidden h-full overflow-y-auto p-6 pb-24 lg:pb-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="relative w-full md:w-1/2 group">
                            <input id="inv-search" onkeyup="app.filterInv()" type="text" placeholder="بحث شامل..." class="pl-12 h-12 bg-white border-gray-200 shadow-sm focus:ring-2 focus:ring-primary/20">
                            <i class="fa fa-search absolute right-4 top-4 text-gray-400 group-focus-within:text-primary transition"></i>
                        </div>
                        <button onclick="app.toggleModal('modal-product')" class="w-full md:w-auto bg-primary hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition transform hover:-translate-y-1">
                            <i class="fa fa-plus"></i> توريد / إضافة
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-soft">
                        <table class="w-full text-right text-sm whitespace-nowrap">
                            <thead>
                                <tr>
                                    <th>المنتج والمورد</th>
                                    <th>الباركود</th>
                                    <th>الفئة</th>
                                    <th>الشراء</th>
                                    <th>البيع</th>
                                    <th>المخزون</th>
                                    <th>تحكم</th>
                                </tr>
                            </thead>
                            <tbody id="inv-table" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-partners" class="view-section hidden h-full overflow-y-auto p-6 pb-24 lg:pb-6">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h3 class="font-bold text-2xl text-gray-800">قائمة العملاء</h3>
                            <p class="text-sm text-gray-500 mt-1">إجمالي المديونيات: <span id="dash-debt-view" class="text-danger font-bold bg-red-50 px-2 rounded">0.00</span></p>
                        </div>
                        <button onclick="app.addCustomerPrompt()" class="bg-primary text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition flex items-center gap-2"><i class="fa fa-user-plus"></i> عميل جديد</button>
                    </div>
                    <div id="customers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-finance" class="view-section hidden h-full overflow-y-auto p-6 pb-24 lg:pb-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 h-fit shadow-card sticky top-6">
                            <h3 class="font-bold text-xl text-gray-800 mb-6 pb-4 border-b border-gray-100">تسجيل مصروف</h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 mb-2 block">بند المصروف</label>
                                    <input id="exp-desc" type="text" placeholder="سبب الصرف..." class="bg-gray-50">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 mb-2 block">المبلغ</label>
                                    <input id="exp-amount" type="number" placeholder="0.00" class="bg-gray-50">
                                </div>
                                <button onclick="app.addExpense()" class="w-full bg-danger hover:bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition transform active:scale-95">تسجيل خصم</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 overflow-hidden h-[600px] flex flex-col shadow-card">
                            <div class="p-5 bg-gray-50 font-bold border-b border-gray-200 text-gray-700 flex justify-between">
                                <span>سجل الحركات المالية</span>
                                <i class="fa fa-money-bill-transfer text-gray-400"></i>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scroll">
                                <table class="w-full text-right text-sm"><tbody id="finance-table" class="divide-y divide-gray-100"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-invoices" class="view-section hidden h-full overflow-y-auto p-6 pb-24 lg:pb-6">
                    <h3 class="font-bold text-2xl text-gray-800 mb-6">أرشيف الفواتير</h3>
                    <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-soft">
                        <table class="w-full text-right text-sm whitespace-nowrap">
                            <thead><tr><th>رقم الفاتورة</th><th>التاريخ</th><th>العميل</th><th>المبلغ</th><th>الحالة</th><th>إجراء</th></tr></thead>
                            <tbody id="invoices-table" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <nav class="lg:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around p-2 z-50 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.05)] h-20">
            <button onclick="app.nav('dashboard')" id="mob-dashboard" class="flex flex-col items-center text-gray-400 text-[10px] p-2 rounded-xl transition w-16"><i class="fa fa-chart-pie text-xl mb-1"></i><span>رئيسية</span></button>
            <button onclick="app.nav('pos')" id="mob-pos" class="flex flex-col items-center text-gray-400 text-[10px] p-2 rounded-xl transition w-16"><i class="fa fa-cash-register text-xl mb-1"></i><span>بيع</span></button>
            <button onclick="app.nav('inventory')" id="mob-inventory" class="flex flex-col items-center text-gray-400 text-[10px] p-2 rounded-xl transition w-16"><i class="fa fa-boxes text-xl mb-1"></i><span>مخزن</span></button>
            <button onclick="app.nav('partners')" id="mob-partners" class="flex flex-col items-center text-gray-400 text-[10px] p-2 rounded-xl transition w-16"><i class="fa fa-users text-xl mb-1"></i><span>عملاء</span></button>
            <button onclick="app.nav('finance')" id="mob-finance" class="flex flex-col items-center text-gray-400 text-[10px] p-2 rounded-xl transition w-16"><i class="fa fa-wallet text-xl mb-1"></i><span>خزينة</span></button>
        </nav>
    </div>

    <div id="modal-product" class="fixed inset-0 bg-slate-900/60 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-8 relative">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
                <h3 class="font-bold text-gray-800 text-xl">بيانات الصنف</h3>
                <button onclick="app.toggleModal('modal-product')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i class="fa fa-times"></i></button>
            </div>
            <div class="space-y-5">
                <div class="relative group">
                    <label class="text-xs font-bold text-primary mb-1.5 block">اسم المنتج (بحث ذكي)</label>
                    <input id="m-name" oninput="app.searchProductForUpdate()" type="text" placeholder="اكتب للبحث أو الإضافة..." class="pl-10">
                    <i class="fa fa-search absolute left-3 top-9 text-gray-400"></i>
                    <div id="m-suggestions" class="suggestions-list hidden"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-1.5 block">الشركة الموردة</label>
                    <input id="m-supplier" type="text" placeholder="مثال: الشريف...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-1.5 block">الفئة</label>
                        <select id="m-cat"><option value="تأسيس">تأسيس</option><option value="نواكل">نواكل</option><option value="اكسسوار">اكسسوار</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-1.5 block">الباركود</label>
                        <input id="m-barcode" type="text">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-2xl border border-dashed border-gray-300">
                    <div>
                        <label class="text-xs font-bold text-gray-600 mb-1.5 block">سعر الشراء</label>
                        <input id="m-buy" type="number" class="border-gray-300">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-primary mb-1.5 block">سعر البيع</label>
                        <input id="m-sell" type="number" class="border-primary/30 text-primary font-bold">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-800 mb-1.5 block">الكمية الواردة</label>
                        <input id="m-qty" type="number" placeholder="0">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-1.5 block">حد الطلب</label>
                        <input id="m-min" type="number" value="5">
                    </div>
                </div>
                <button onclick="app.saveProduct()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition mt-2">
                    حفظ البيانات
                </button>
            </div>
        </div>
    </div>

    <div id="print-area-wrapper">
        <div id="receipt-template" style="width: 78mm; background: #fff; color: #000; padding: 10px; font-family: 'Tajawal', sans-serif; font-size: 11px;">
            <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 8px; margin-bottom: 8px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 800;">المهندس للسباكة</h2>
                <p style="margin: 3px 0; font-size: 10px;">إيصال / فاتورة</p>
                <p style="font-size: 9px;">تاريخ: <span id="r-date"></span> | رقم: <span id="r-id"></span></p>
            </div>
            <div style="margin-bottom: 8px; font-size: 12px;"><strong>العميل: </strong> <span id="r-customer"></span></div>
            <div style="margin-bottom: 8px; font-size: 12px; font-weight: bold;" id="r-type-label"></div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead><tr style="border-bottom: 1px solid #000;"><th style="text-align:right">صنف</th><th style="text-align:center">عدد</th><th style="text-align:left">سعر</th></tr></thead>
                <tbody id="r-items"></tbody>
            </table>
            <div style="border-top: 1px solid #000; margin-top: 8px; padding-top: 5px; display: flex; justify-content: space-between; font-weight: bold; font-size: 16px;">
                <span>الإجمالي:</span><span id="r-total"></span>
            </div>
            <div style="margin-top: 10px; text-align: center;"><svg id="r-barcode"></svg></div>
            <div style="text-align:center; font-size:9px; margin-top:5px; font-weight:bold;">SABBAK ERP</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, deleteDoc, writeBatch, query, orderBy, limit, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChNPxcmhJywadU4QhOPs-pgulxvCNr0ec",
            authDomain: "adham-atia.firebaseapp.com",
            projectId: "adham-atia",
            storageBucket: "adham-atia.firebasestorage.app",
            messagingSenderId: "743105915809",
            appId: "1:743105915809:web:af26bab182b60e1870b9e0"
        };

        let db;
        try {
            const appInit = initializeApp(firebaseConfig);
            db = getFirestore(appInit);
            console.log("System Connected");
        } catch(e) { Swal.fire('خطأ اتصال', 'تأكد من الإنترنت', 'error'); }

        const state = { products: [], cart: [], customers: [], filterCat: 'all', chart: null, isReturnMode: false };

        window.app = {
            nav: (view) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                
                const titles = { 'dashboard': 'لوحة القيادة', 'pos': 'نقطة البيع', 'inventory': 'المخزن', 'partners': 'العملاء', 'finance': 'المالية', 'invoices': 'الفواتير' };
                document.getElementById('page-title').innerText = titles[view];
                
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-blue-50', 'text-primary', 'shadow-sm');
                    b.classList.add('text-gray-500');
                });
                const activeBtn = document.getElementById(`nav-${view}`);
                if(activeBtn) activeBtn.classList.add('bg-blue-50', 'text-primary', 'shadow-sm');
                
                document.querySelectorAll('[id^="mob-"]').forEach(b => b.classList.remove('text-primary', 'font-bold'));
                const mob = document.getElementById(`mob-${view}`);
                if(mob) mob.classList.add('text-primary', 'font-bold');
            },

            toggleModal: (id) => {
                const el = document.getElementById(id);
                const isHidden = el.classList.contains('hidden');
                if(isHidden) {
                    el.classList.remove('hidden');
                    if(id === 'modal-product') {
                        document.getElementById('m-name').focus();
                        document.getElementById('m-suggestions').innerHTML = '';
                    }
                } else { el.classList.add('hidden'); }
            },

            // --- Inventory Logic ---
            searchProductForUpdate: () => {
                const val = document.getElementById('m-name').value.toLowerCase();
                const list = document.getElementById('m-suggestions');
                list.innerHTML = '';
                if(val.length < 2) { list.classList.add('hidden'); return; }

                const matches = state.products.filter(p => p.name.toLowerCase().includes(val));
                if(matches.length > 0) {
                    list.classList.remove('hidden');
                    matches.slice(0, 5).forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `<span class="font-bold">${p.name}</span> <span class="text-xs text-gray-400">${p.supplier || ''}</span>`;
                        div.onclick = () => {
                            document.getElementById('m-name').value = p.name;
                            document.getElementById('m-supplier').value = p.supplier || '';
                            document.getElementById('m-cat').value = p.category;
                            document.getElementById('m-barcode').value = p.barcode || '';
                            document.getElementById('m-buy').value = p.buy;
                            document.getElementById('m-sell').value = p.sell;
                            document.getElementById('m-min').value = p.min;
                            document.getElementById('m-qty').focus();
                            list.classList.add('hidden');
                            Swal.fire({toast:true, icon:'info', title:'تم جلب البيانات، أدخل الكمية للإضافة', position:'top', timer:2000, showConfirmButton:false});
                        };
                        list.appendChild(div);
                    });
                } else { list.classList.add('hidden'); }
            },

            saveProduct: async () => {
                const name = document.getElementById('m-name').value.trim();
                const supplier = document.getElementById('m-supplier').value.trim() || "غير محدد";
                const qty = Number(document.getElementById('m-qty').value);
                const buy = Number(document.getElementById('m-buy').value);
                const sell = Number(document.getElementById('m-sell').value);
                const cat = document.getElementById('m-cat').value;
                const barcode = document.getElementById('m-barcode').value;
                const min = Number(document.getElementById('m-min').value);

                if(!name || !buy || !sell) return Swal.fire('تنبيه', 'بيانات ناقصة', 'warning');

                Swal.showLoading();
                try {
                    const batch = writeBatch(db);
                    const q = query(collection(db, "products"), where("name", "==", name));
                    const querySnapshot = await getDocs(q);

                    let actionText = "";
                    let totalCost = buy * qty;

                    if (!querySnapshot.empty) {
                        const existingDoc = querySnapshot.docs[0];
                        batch.update(existingDoc.ref, {
                            qty: increment(qty), buy, sell, supplier, category: cat,
                            barcode: barcode || existingDoc.data().barcode 
                        });
                        actionText = `تم التحديث: ${name}`;
                    } else {
                        const newRef = doc(collection(db, "products"));
                        batch.set(newRef, { name, category: cat, supplier, barcode: barcode || Date.now().toString(), buy, sell, qty, min });
                        actionText = `تم إضافة: ${name}`;
                    }

                    if(qty > 0) {
                        const txRef = doc(collection(db, "transactions"));
                        batch.set(txRef, { type: 'purchase', amount: totalCost, details: `شراء: ${name} (${qty})`, date: new Date().toISOString() });
                    }

                    await batch.commit();
                    window.app.toggleModal('modal-product');
                    document.querySelectorAll('#modal-product input').forEach(i => i.value = '');
                    Swal.fire({icon:'success', title: actionText, toast:true, timer:2000, position:'top-end', showConfirmButton:false});

                } catch(e) { Swal.fire('خطأ', e.message, 'error'); }
            },

            delProduct: async (id) => {
                if((await Swal.fire({title:'حذف الصنف؟', text:'لا يمكن التراجع', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'})).isConfirmed) {
                    await deleteDoc(doc(db, "products", id));
                    Swal.fire({icon:'success', title:'تم الحذف', toast:true, timer:1500, position:'top-end', showConfirmButton:false});
                }
            },

            filterInv: () => {
                const q = document.getElementById('inv-search').value.toLowerCase();
                const rows = document.querySelectorAll('#inv-table tr');
                rows.forEach(r => {
                    const txt = r.innerText.toLowerCase();
                    r.style.display = txt.includes(q) ? '' : 'none';
                });
            },

            // --- POS Logic ---
            toggleReturnMode: () => {
                state.isReturnMode = !state.isReturnMode;
                const btn = document.getElementById('btn-return-mode');
                const label = document.getElementById('tx-mode-label');
                if(state.isReturnMode) {
                    btn.classList.add('bg-red-50', 'text-danger', 'border-danger', 'return-mode-active');
                    btn.innerHTML = `<i class="fa fa-check"></i> المرتجع مفعل`;
                    label.innerText = '⚠️ فاتورة مرتجع (استرجاع أموال)';
                    label.classList.add('text-danger', 'font-bold');
                    // Reset cart to avoid mixing
                    if(state.cart.length > 0) Swal.fire({toast:true, title:'تم تفريغ السلة لتغيير الوضع', icon:'info', position:'top'});
                    state.cart = [];
                    window.app.renderCart();
                } else {
                    btn.classList.remove('bg-red-50', 'text-danger', 'border-danger', 'return-mode-active');
                    btn.innerHTML = `<i class="fa fa-rotate-left mb-1"></i> وضع المرتجع`;
                    label.innerText = 'بيع عادي';
                    label.classList.remove('text-danger', 'font-bold');
                    state.cart = [];
                    window.app.renderCart();
                }
            },

            filterCat: (cat) => {
                state.filterCat = cat;
                document.querySelectorAll('.cat-btn').forEach(b => {
                    b.classList.remove('bg-primary', 'text-white', 'shadow-lg');
                    b.classList.add('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                    if(b.innerText.includes(cat === 'all' ? 'الكل' : cat)) {
                        b.classList.remove('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                        b.classList.add('bg-primary', 'text-white', 'shadow-lg');
                    }
                });
                window.app.filterPos();
            },

            filterPos: () => {
                const q = document.getElementById('pos-search').value.toLowerCase();
                const grid = document.getElementById('pos-grid');
                grid.innerHTML = '';
                
                state.products.forEach(p => {
                    const matchName = p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.includes(q));
                    const matchCat = state.filterCat === 'all' || p.category === state.filterCat;
                    
                    if(matchName && matchCat) {
                        grid.innerHTML += `
                            <div onclick="window.app.addToCart('${p.id}')" class="bg-white p-4 rounded-2xl border border-gray-100 cursor-pointer hover:border-primary relative overflow-hidden active:scale-95 transition group select-none shadow-soft hover:shadow-card h-32 flex flex-col justify-between">
                                ${p.qty<=0 ? '<div class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center text-danger font-bold z-10 text-sm border-2 border-danger rounded-xl">نفذت الكمية</div>' : ''}
                                <div class="flex justify-between items-start">
                                    <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold">${p.category}</span>
                                    <span class="text-[10px] ${p.qty<=p.min?'text-danger font-bold':'text-success font-bold'}">${p.qty} متاح</span>
                                </div>
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-2 leading-snug mt-1">${p.name}</h4>
                                <div class="flex justify-between items-end mt-auto">
                                    <span class="text-base font-black text-gray-800">${p.sell} <span class="text-[9px] text-gray-400 font-normal">ج.م</span></span>
                                    <div class="w-8 h-8 rounded-full bg-blue-50 text-primary flex items-center justify-center text-xs shadow-sm group-hover:bg-primary group-hover:text-white transition"><i class="fa fa-plus"></i></div>
                                </div>
                            </div>`;
                    }
                });
            },

            addToCart: (id) => {
                const p = state.products.find(x => x.id === id);
                if(!state.isReturnMode && p.qty <= 0) return Swal.fire({toast:true, icon:'error', title:'غير متوفر', position:'top', timer:1500, showConfirmButton:false});
                
                const ex = state.cart.find(x => x.id === id);
                if(ex) {
                    if(!state.isReturnMode && ex.qty >= p.qty) return Swal.fire({toast:true, icon:'warning', title:'لا يوجد رصيد', position:'top', timer:1500, showConfirmButton:false});
                    ex.qty++;
                } else { state.cart.push({...p, qty:1}); }
                window.app.renderCart();
            },

            renderCart: () => {
                const div = document.getElementById('cart-items');
                div.innerHTML = '';
                let total = 0;
                
                state.cart.forEach((item, i) => {
                    const itemTotal = item.sell * item.qty;
                    total += itemTotal;
                    div.innerHTML += `
                        <div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center text-sm shadow-sm relative overflow-hidden">
                            ${state.isReturnMode ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-danger"></div>' : ''}
                            <div class="flex-1 min-w-0 pr-2">
                                <div class="font-bold text-gray-800 truncate">${item.name}</div>
                                <div class="text-xs text-gray-400">${item.sell} × ${item.qty}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 h-8">
                                    <button onclick="window.app.upQty(${i}, -1)" class="w-8 h-full text-gray-500 hover:text-primary hover:bg-white rounded-r-lg font-bold text-sm transition">-</button>
                                    <span class="w-8 text-center text-gray-800 text-sm font-bold">${item.qty}</span>
                                    <button onclick="window.app.upQty(${i}, 1)" class="w-8 h-full text-gray-500 hover:text-primary hover:bg-white rounded-l-lg font-bold text-sm transition">+</button>
                                </div>
                                <button onclick="window.app.delCart(${i})" class="text-danger hover:bg-red-50 p-2 rounded-lg transition"><i class="fa fa-trash-can"></i></button>
                            </div>
                        </div>`;
                });
                
                if(state.cart.length === 0) div.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300 opacity-60"><i class="fa fa-basket-shopping text-5xl mb-3"></i><p>السلة فارغة</p></div>`;
                document.getElementById('cart-total').innerText = total.toFixed(2);
                document.getElementById('cart-count').innerText = state.cart.length;
            },

            upQty: (i, v) => {
                const item = state.cart[i];
                const p = state.products.find(x => x.id === item.id);
                if(!state.isReturnMode && v === 1 && item.qty >= p.qty) return;
                if(v === -1 && item.qty === 1) return window.app.delCart(i);
                item.qty += v;
                window.app.renderCart();
            },

            delCart: (i) => { state.cart.splice(i, 1); window.app.renderCart(); },
            clearCart: () => { state.cart = []; window.app.renderCart(); },

            checkout: async (type) => {
                if(state.cart.length === 0) return Swal.fire('تنبيه', 'السلة فارغة', 'info');
                const cid = document.getElementById('pos-customer').value;
                if(type === 'credit' && cid === 'cash') return Swal.fire('خطأ', 'اختر عميل للآجل', 'warning');
                
                Swal.showLoading();
                const total = Number(document.getElementById('cart-total').innerText);
                const cName = document.getElementById('pos-customer').options[document.getElementById('pos-customer').selectedIndex].text;
                const batch = writeBatch(db);
                
                // Logic Adjustment based on Return Mode
                const multiplier = state.isReturnMode ? -1 : 1; 

                // Inventory Update
                state.cart.forEach(i => {
                    // If return mode: add qty back to stock (+), If sale: remove (-). 
                    // Logic: increment(-1 * 1) = -1 (Sale). increment(-1 * -1) = +1 (Return).
                    batch.update(doc(db, "products", i.id), { qty: increment(-1 * multiplier * i.qty) });
                });

                const ref = doc(collection(db, "invoices"));
                batch.set(ref, {
                    date: new Date().toISOString(), total: total * multiplier, type, 
                    customerId: cid, customerName: cName, items: state.cart, isReturn: state.isReturnMode
                });

                const txRef = doc(collection(db, "transactions"));
                let details = state.isReturnMode ? `مرتجع فاتورة (${type})` : `بيع (${type})`;
                
                // Financials
                if(type === 'cash') {
                    // Sale: +Money, Return: -Money (Expense)
                    const txType = state.isReturnMode ? 'expense' : 'sale_cash'; 
                    batch.set(txRef, { type: txType, amount: total, date: new Date().toISOString(), details: `${details} #${ref.id.substring(0,5)}` });
                } else {
                    // Credit Sale: +Debt, Credit Return: -Debt
                    batch.set(txRef, { type: 'sale_credit', amount: total * multiplier, date: new Date().toISOString(), details: `${details} #${ref.id.substring(0,5)}` });
                    batch.update(doc(db, "customers", cid), { debt: increment(total * multiplier) });
                }

                await batch.commit();
                await window.app.printReceipt(state.cart, total, ref.id, cName);
                state.cart = []; window.app.renderCart();
                // Reset mode after success
                if(state.isReturnMode) app.toggleReturnMode();
                Swal.fire({icon:'success', title:'تم الحفظ بنجاح', toast:true, timer:1500, position:'top', showConfirmButton:false});
            },

            // --- Customers ---
            addCustomerPrompt: async () => {
                const {value: name} = await Swal.fire({input:'text', inputLabel:'اسم العميل', confirmButtonText:'حفظ', showCancelButton:true});
                if(name) await addDoc(collection(db, "customers"), {name, debt:0});
            },
            
            deleteCustomer: async (id, debt) => {
                if(debt > 0) return Swal.fire('لا يمكن الحذف', 'العميل عليه مديونية لم تسدد', 'error');
                if((await Swal.fire({title:'حذف العميل؟', icon:'warning', showCancelButton:true})).isConfirmed) {
                    await deleteDoc(doc(db, "customers", id));
                    Swal.fire({icon:'success', title:'تم الحذف', toast:true, timer:1500, position:'top'});
                }
            },

            payDebt: async (id) => {
                const {value: amt} = await Swal.fire({input:'number', inputLabel:'قيمة الدفعة', confirmButtonText:'تسجيل', showCancelButton:true});
                if(amt) {
                    const b = writeBatch(db);
                    b.update(doc(db, "customers", id), {debt: increment(-Number(amt))});
                    b.set(doc(collection(db, "transactions")), {type: 'payment_in', amount: Number(amt), date: new Date().toISOString(), details: 'سداد دفعة'});
                    await b.commit();
                    Swal.fire('تم السداد');
                }
            },

            // --- Others ---
            addExpense: async () => {
                const desc = document.getElementById('exp-desc').value;
                const amt = document.getElementById('exp-amount').value;
                if(desc && amt) {
                    await addDoc(collection(db, "transactions"), {type:'expense', amount:Number(amt), details:desc, date:new Date().toISOString()});
                    document.getElementById('exp-desc').value = ''; document.getElementById('exp-amount').value = '';
                    Swal.fire({icon:'success', title:'تم الخصم', toast:true, timer:1000, position:'top', showConfirmButton:false});
                }
            },

            printReceipt: (items, total, id, cName) => {
                return new Promise(resolve => {
                    document.getElementById('r-date').innerText = new Date().toLocaleDateString('ar-EG');
                    document.getElementById('r-id').innerText = id.substring(0,6).toUpperCase();
                    document.getElementById('r-customer').innerText = cName;
                    document.getElementById('r-total').innerText = total.toFixed(2);
                    document.getElementById('r-type-label').innerText = state.isReturnMode ? '*** إيصال مرتجع ***' : 'إيصال بيع';
                    document.getElementById('r-items').innerHTML = items.map(i => `
                        <tr style="border-bottom:1px dashed #ccc">
                            <td style="text-align:right; padding:2px 0;">${i.name}</td>
                            <td style="text-align:center">${i.qty}</td>
                            <td style="text-align:left">${(i.sell*i.qty).toFixed(2)}</td>
                        </tr>`).join('');
                    JsBarcode("#r-barcode", id.substring(0,8), {height:30, displayValue:false, margin:5});
                    const el = document.getElementById('receipt-template');
                    html2pdf().from(el).set({ margin:0, filename:`Inv_${id.substring(0,6)}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm', format:[80, 190]} }).save().then(resolve);
                });
            },
            
            downloadInvoice: async (id) => {
                const inv = state.invoices.find(i => i.id === id);
                if(inv) {
                    // Temporary set mode to correctly label the print
                    const oldMode = state.isReturnMode;
                    state.isReturnMode = inv.isReturn || false; 
                    await window.app.printReceipt(inv.items, Math.abs(inv.total), inv.id, inv.customerName);
                    state.isReturnMode = oldMode;
                }
            }
        };

        // ================= LISTENERS =================
        onSnapshot(collection(db, "products"), (snap) => {
            state.products = [];
            let low = 0, invH = '', cats = {}, stockVal = 0;
            snap.forEach(d => {
                const p = {id:d.id, ...d.data()};
                state.products.push(p);
                if(p.qty <= p.min) low++;
                cats[p.category] = (cats[p.category] || 0) + 1;
                stockVal += (p.sell * p.qty);
                invH += `
                    <tr class="group hover:bg-blue-50/50 transition border-b border-gray-100">
                        <td class="p-4 rounded-r-xl">
                            <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                            <div class="text-[11px] text-gray-500 mt-0.5"><i class="fa fa-truck-field"></i> ${p.supplier||'-'}</div>
                        </td>
                        <td class="text-xs text-gray-400 font-mono select-all">${p.barcode}</td>
                        <td><span class="bg-gray-100 px-2.5 py-1 rounded-lg text-xs font-bold text-gray-600">${p.category}</span></td>
                        <td class="text-gray-500 font-medium text-xs">${p.buy}</td>
                        <td class="text-primary font-bold text-sm">${p.sell}</td>
                        <td class="${p.qty <= p.min ? 'text-danger font-black' : 'text-success font-bold'} text-lg">${p.qty}</td>
                        <td class="rounded-l-xl">
                            <button onclick="window.app.delProduct('${p.id}')" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition shadow-sm border border-gray-200"><i class="fa fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('inv-table').innerHTML = invH;
            document.getElementById('dash-low').innerText = low;
            document.getElementById('dash-stock-val').innerText = stockVal.toLocaleString();
            document.getElementById('loader').style.display = 'none';
            window.app.filterPos();
            updateChart(cats);
        });

        onSnapshot(collection(db, "customers"), (snap) => {
            state.customers = [];
            let debtTotal = 0, grid = '', opts = '<option value="cash">عميل نقدي (طياري)</option>';
            snap.forEach(d => {
                const c = {id:d.id, ...d.data()};
                state.customers.push(c);
                debtTotal += c.debt;
                opts += `<option value="${c.id}">${c.name}</option>`;
                grid += `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center relative overflow-hidden hover:border-blue-300 transition shadow-card group">
                        <div class="absolute right-0 top-0 bottom-0 w-1 ${c.debt>0?'bg-danger':'bg-success'}"></div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${c.name}</h4>
                            <p class="text-sm text-gray-500">مديونية: <span class="${c.debt>0?'text-danger font-bold':'text-success'}">${c.debt.toFixed(2)}</span></p>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${c.debt > 0 ? `<button onclick="window.app.payDebt('${c.id}')" class="bg-blue-50 text-primary hover:bg-primary hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition">سداد</button>` : ''}
                            <button onclick="window.app.deleteCustomer('${c.id}', ${c.debt})" class="text-gray-300 hover:text-danger transition text-xs"><i class="fa fa-trash"></i> حذف</button>
                        </div>
                    </div>`;
            });
            document.getElementById('customers-grid').innerHTML = grid;
            document.getElementById('pos-customer').innerHTML = opts;
            document.getElementById('dash-debt-view').innerText = debtTotal.toFixed(2);
        });

        onSnapshot(query(collection(db, "transactions"), orderBy("date", "desc"), limit(60)), (snap) => {
            let sales = 0, profit = 0, safe = 0, html = '', recent = '';
            const today = new Date().toDateString();
            snap.forEach((d, i) => {
                const t = d.data();
                if(t.type.includes('sale_cash') || t.type === 'payment_in') safe += t.amount;
                else safe -= t.amount;
                
                if(new Date(t.date).toDateString() === today && t.type.includes('sale')) { 
                    // Handle profit calculation carefully (not fully implemented in return logic for simplicity here)
                    sales += t.amount; 
                }
                
                const isPos = ['sale_cash','payment_in'].includes(t.type);
                const color = isPos ? 'text-success' : 'text-danger';
                const sign = isPos ? '+' : '-';
                
                html += `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                        <td class="p-3 text-xs text-gray-400 font-mono">${new Date(t.date).toLocaleDateString()}</td>
                        <td><span class="px-2 py-1 rounded text-[10px] bg-gray-100 border border-gray-200 text-gray-600 font-bold">${t.type}</span></td>
                        <td class="text-xs text-gray-600 font-medium">${t.details}</td>
                        <td class="font-bold ${color} text-left dir-ltr">${t.amount.toFixed(2)}</td>
                    </tr>`;
                if(i < 6) recent += `
                    <div class="flex justify-between items-center text-sm p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2">
                        <div class="flex flex-col"><span class="text-gray-700 font-bold text-xs">${t.details}</span><span class="text-[10px] text-gray-400">${new Date(t.date).toLocaleTimeString('ar-EG')}</span></div>
                        <span class="${color} font-bold">${sign}${t.amount}</span>
                    </div>`;
            });
            document.getElementById('finance-table').innerHTML = html;
            document.getElementById('dash-recent-tx').innerHTML = recent;
            document.getElementById('dash-sales').innerText = sales.toFixed(0);
            document.getElementById('sidebar-safe').innerText = safe.toLocaleString();
        });

        onSnapshot(query(collection(db, "invoices"), orderBy("date", "desc"), limit(50)), (snap) => {
            state.invoices = [];
            let html = '';
            snap.forEach(d => {
                const i = {id:d.id, ...d.data()};
                state.invoices.push(i);
                html += `
                    <tr class="hover:bg-blue-50/50 transition border-b border-gray-100">
                        <td class="p-4 text-xs font-mono text-primary font-bold">#${i.id.substring(0,6).toUpperCase()}</td>
                        <td class="text-xs text-gray-500">${new Date(i.date).toLocaleDateString()}</td>
                        <td class="text-gray-800 font-bold text-xs">${i.customerName}</td>
                        <td class="font-bold ${i.total < 0 ? 'text-danger' : 'text-gray-800'}">${Math.abs(i.total)}</td>
                        <td><span class="text-[10px] px-2 py-1 rounded bg-gray-100 border border-gray-200 text-gray-600">${i.isReturn?'مرتجع':(i.type==='cash'?'كاش':'آجل')}</span></td>
                        <td><button onclick="window.app.downloadInvoice('${i.id}')" class="text-gray-400 hover:text-primary transition w-8 h-8 rounded-full hover:bg-white border border-transparent hover:border-gray-200 flex items-center justify-center shadow-sm"><i class="fa fa-print"></i></button></td>
                    </tr>`;
            });
            document.getElementById('invoices-table').innerHTML = html;
        });

        function updateChart(data) {
            const ctx = document.getElementById('mainChart');
            if(state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(data), datasets: [{ label:'عدد الأصناف', data: Object.values(data), backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }
    </script>
</body>
</html>
